<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade Details - P2P Escrow</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <!-- Header -->
  <nav class="bg-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <h1 class="text-2xl font-bold text-indigo-600">Trade Details</h1>
        <div id="user-info" class="text-sm text-gray-600"></div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Navigation -->
    <div class="mb-6 flex flex-wrap gap-3">
      <a href="index.html" class="inline-flex items-center text-indigo-600 hover:text-indigo-800 font-medium">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Trades
      </a>
      <a href="chats.html" class="text-gray-600 hover:text-gray-800 font-medium">My Chats</a>
      <button onclick="loadTrade()" class="text-gray-600 hover:text-gray-800 font-medium">Refresh</button>
    </div>

    <!-- Trade Details Card -->
    <div id="trade-details" class="bg-white rounded-lg shadow-lg p-8 mb-6"></div>

    <!-- Role Note -->
    <div id="role-note" class="mb-6"></div>

    <!-- Actions Card -->
    <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Actions</h2>
      <div class="flex flex-wrap gap-3">
        <button id="buy-btn" onclick="buyTrade()" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition shadow-md">
          Buy This Trade
        </button>
        <button id="release-btn" onclick="releaseTrade()" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition shadow-md">
          Release Escrow
        </button>
        <button id="cancel-btn" onclick="cancelTrade()" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition shadow-md">
          Cancel Trade
        </button>
        <button onclick="openChat()" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition shadow-md">
          Open Chat
        </button>
      </div>
    </div>

    <!-- Status Messages -->
    <div id="trade-status"></div>
  </div>

  <!-- Scripts -->
  <script src="assets/js/auth-service.js"></script>
  <script src="assets/js/api-service.js"></script>
  <script src="assets/js/ui-utils.js"></script>
  <script src="assets/js/notification-system.js"></script>
  <script>
    AuthService.requireAuth();
    AuthService.displayUserInfo();

    const urlParams = new URLSearchParams(window.location.search);
    const tradeId = urlParams.get('trade');
    let currentTrade = null;
    const userId = AuthService.getUserId();

    if (!tradeId) {
      document.body.innerHTML = '<div class="max-w-4xl mx-auto px-4 py-8"><h1 class="text-2xl font-bold text-red-600">Error: No trade ID provided</h1><a href="index.html" class="text-indigo-600">Go back</a></div>';
    }

    async function loadTrade() {
      console.log('Loading trade details for trade:', tradeId);
      UIUtils.showLoading('trade-details', 'Loading trade details...');

      try {
        const result = await ApiService.getTrade(tradeId);

        if (!result.success) {
          throw new Error(result.message || 'Failed to load trade');
        }

        currentTrade = result.data;

        if (!currentTrade) {
          throw new Error('Trade not found');
        }

        displayTrade(currentTrade);
        updateButtonStates(currentTrade);
      } catch (error) {
        console.error('Error loading trade:', error);
        UIUtils.showError('trade-details', error);
      }
    }

    function displayTrade(trade) {
      const container = document.getElementById('trade-details');
      container.innerHTML = `
        <div class="flex justify-between items-start mb-6">
          <h2 class="text-3xl font-bold text-gray-800">Trade #${trade.id}</h2>
          ${UIUtils.getStatusBadge(trade.status)}
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <p class="text-sm text-gray-500 mb-1">Asset</p>
            <p class="text-lg font-bold text-gray-800">${trade.asset}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500 mb-1">Amount</p>
            <p class="text-lg font-bold text-gray-800">${trade.amount}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500 mb-1">Seller</p>
            <p class="text-lg font-bold text-gray-800">${trade.seller_name}${trade.seller_id === userId ? ' (You)' : ''}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500 mb-1">Buyer</p>
            <p class="text-lg font-bold text-gray-800">${trade.buyer_name ? trade.buyer_name + (trade.buyer_id === userId ? ' (You)' : '') : 'None yet'}</p>
          </div>
        </div>
      `;
    }

    function updateButtonStates(trade) {
      const buyBtn = document.getElementById('buy-btn');
      const releaseBtn = document.getElementById('release-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      const roleNote = document.getElementById('role-note');

      const isSeller = trade.seller_id === userId;
      const isBuyer = trade.buyer_id === userId;

      roleNote.innerHTML = '';

      if (isSeller) {
        buyBtn.disabled = true;
        buyBtn.classList.add('opacity-50', 'cursor-not-allowed');
        buyBtn.style.display = 'none';
        
        releaseBtn.disabled = trade.status !== 'in_progress';
        if (releaseBtn.disabled) releaseBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        cancelBtn.disabled = !(trade.status === 'open' || trade.status === 'in_progress');
        if (cancelBtn.disabled) cancelBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        roleNote.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-800 rounded-lg p-4"><strong class="font-bold">You are the seller</strong> - You can release funds when buyer confirms payment, or cancel the trade.</div>';
      } else if (isBuyer) {
        buyBtn.disabled = true;
        buyBtn.classList.add('opacity-50', 'cursor-not-allowed');
        buyBtn.style.display = 'none';
        
        releaseBtn.disabled = true;
        releaseBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        cancelBtn.disabled = trade.status !== 'in_progress';
        if (cancelBtn.disabled) cancelBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        roleNote.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-800 rounded-lg p-4"><strong class="font-bold">You are the buyer</strong> - Complete payment and notify seller to release escrow.</div>';
      } else {
        buyBtn.disabled = trade.status !== 'open';
        if (buyBtn.disabled) buyBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        releaseBtn.disabled = true;
        releaseBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        cancelBtn.disabled = true;
        cancelBtn.classList.add('opacity-50', 'cursor-not-allowed');
        
        if (trade.status === 'open') {
          roleNote.innerHTML = '<div class="bg-indigo-50 border border-indigo-200 text-indigo-800 rounded-lg p-4">This trade is available. Click "Buy This Trade" to initiate.</div>';
        }
      }
    }

    async function buyTrade() {
      if (!UIUtils.confirm('Do you want to buy this trade?')) return;
      await performAction('buy', userId, 'Purchasing trade...');
    }

    async function releaseTrade() {
      if (!UIUtils.confirm('Have you received payment? Releasing escrow will complete the trade and cannot be undone.')) return;
      await performAction('release', userId, 'Releasing escrow...');
    }

    async function cancelTrade() {
      if (!UIUtils.confirm('Are you sure you want to cancel this trade?')) return;
      await performAction('cancel', userId, 'Cancelling trade...');
    }

    async function performAction(action, userId, loadingMsg) {
      console.log(`Performing action: ${action}`);
      UIUtils.showLoading('trade-status', loadingMsg);

      try {
        let result;
        if (action === 'buy') {
          result = await ApiService.buyTrade(tradeId, userId);
        } else if (action === 'release') {
          result = await ApiService.releaseTrade(tradeId, userId);
        } else if (action === 'cancel') {
          result = await ApiService.cancelTrade(tradeId, userId);
        }

        if (!result.success) {
          throw new Error(result.message || 'Action failed');
        }

        UIUtils.showMessage('trade-status', result.message, 'success');
        setTimeout(() => loadTrade(), 1000);
      } catch (error) {
        console.error(`Error performing ${action}:`, error);
        UIUtils.showMessage('trade-status', error.message, 'error');
      }
    }

    function openChat() {
      window.location.href = `chat.html?trade=${tradeId}`;
    }

    loadTrade();
  </script>
</body>
</html>